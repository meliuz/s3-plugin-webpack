!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("lodash"),require("progress"),require("cdnizer"),require("aws-sdk"),require("recursive-readdir")):"function"==typeof define&&define.amd?define(["lodash","progress","cdnizer","aws-sdk","recursive-readdir"],e):"object"==typeof exports?exports["webpack-s3-plugin"]=e(require("lodash"),require("progress"),require("cdnizer"),require("aws-sdk"),require("recursive-readdir")):t["webpack-s3-plugin"]=e(t.lodash,t.progress,t.cdnizer,t["aws-sdk"],t["recursive-readdir"])}(global,function(t,e,i,a,o){return function(t){var e={};function i(a){if(e[a])return e[a].exports;var o=e[a]={i:a,l:!1,exports:{}};return t[a].call(o.exports,o,o.exports,i),o.l=!0,o.exports}return i.m=t,i.c=e,i.d=function(t,e,a){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:a})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var a=Object.create(null);if(i.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)i.d(a,o,function(e){return t[e]}.bind(null,o));return a},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=2)}([function(t,e){t.exports=require("path")},function(e,i){e.exports=t},function(t,e,i){"use strict";var a=f(i(3)),o=f(i(4)),n=f(i(5)),p=f(i(0)),s=f(i(6)),r=f(i(7)),l=f(i(1)),c=f(i(8)),m=i(11),d=f(i(12)),u=i(13);function f(t){return t&&t.__esModule?t:{default:t}}function x(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,i){return function a(o,n){try{var p=e[o](n),s=p.value}catch(t){return void i(t)}if(!p.done)return Promise.resolve(s).then(function(t){a("next",t)},function(t){a("throw",t)});t(s)}("next")})}}a.default.globalAgent.maxSockets=o.default.globalAgent.maxSockets=50;const h=function(t,e){t.errors.push(new Error(e))};t.exports=class{constructor(t={}){var{include:e,exclude:i,progress:a,basePath:o,directory:n,htmlFiles:p,basePathTransform:s=u.DEFAULT_TRANSFORM,s3Options:r={},cdnizerOptions:c={},s3UploadOptions:m={},cloudfrontInvalidateOptions:d={},priority:f}=t;this.uploadOptions=m,this.cloudfrontInvalidateOptions=d,this.isConnected=!1,this.cdnizerOptions=c,this.urlMappings=[],this.uploadTotal=0,this.uploadProgress=0,this.basePathTransform=s,o=o?(0,u.addTrailingS3Sep)(o):"",this.options={directory:n,include:e,exclude:i,basePath:o,priority:f,htmlFiles:"string"==typeof p?[p]:p,progress:!l.default.isBoolean(a)||a},this.clientConfig={s3Options:r,maxAsyncS3:50},this.noCdnizer=!Object.keys(this.cdnizerOptions).length,this.noCdnizer||this.cdnizerOptions.files||(this.cdnizerOptions.files=[])}apply(t){var e=this;this.connect();const i=!!this.options.directory,a=l.default.every(u.REQUIRED_S3_UP_OPTS,t=>this.uploadOptions[t]);this.options.directory=this.options.directory||t.options.output.path||t.options.output.context||".",t.hooks.afterEmit.tapPromise(d.default.name,(()=>{var t=x(function*(t){var o;if(a||(o=`S3Plugin-RequiredS3UploadOpts: ${u.REQUIRED_S3_UP_OPTS.join(", ")}`),o)return h(t,o);if(i){const i=(0,u.addSeperatorToPath)(e.options.directory);return e.getAllFilesRecursive(i).then(function(t){return e.handleFiles(t)}).catch(function(i){return e.handleErrors(i,t)})}return e.getAssetFiles(t).then(function(t){return e.handleFiles(t)}).catch(function(i){return e.handleErrors(i,t)})});return function(e){return t.apply(this,arguments)}})())}handleFiles(t){return this.changeUrls(t).then(t=>this.filterAllowedFiles(t)).then(t=>this.uploadFiles(t)).then(()=>this.invalidateCloudfront())}handleErrors(t,e){return x(function*(){throw h(e,`S3Plugin: ${t}`),t})()}getAllFilesRecursive(t){return(0,u.getDirectoryFilesRecursive)(t)}addPathToFiles(t,e){return t.map(t=>({name:t,path:p.default.resolve(e,t)}))}getFileName(t=""){return l.default.includes(t,u.PATH_SEP)?t.substring(l.default.lastIndexOf(t,u.PATH_SEP)+1):t}getAssetFiles({assets:t}){const e=l.default.map(t,(t,e)=>({name:e,path:t.existsAt}));return Promise.resolve(e)}cdnizeHtml(t){return new Promise((e,i)=>{n.default.readFile(t.path,(a,o)=>{if(a)return i(a);n.default.writeFile(t.path,this.cdnizer(o.toString()),a=>{if(a)return i(a);e(t)})})})}changeUrls(t=[]){if(this.noCdnizer)return Promise.resolve(t);var e;const{directory:i,htmlFiles:a=[]}=this.options;e=a.length?this.addPathToFiles(a,i).concat(t):t,this.cdnizerOptions.files=e.map(({name:t})=>`{/,}*${t}*`),this.cdnizer=(0,r.default)(this.cdnizerOptions);const[o,n]=(0,l.default)(e).uniq("name").partition(t=>/\.(html|css)/.test(t.name)).value();return Promise.all(o.map(t=>this.cdnizeHtml(t)).concat(n))}filterAllowedFiles(t){return t.reduce((t,e)=>(this.isIncludeAndNotExclude(e.name)&&!this.isIgnoredFile(e.name)&&t.push(e),t),[])}isIgnoredFile(t){return l.default.some(u.UPLOAD_IGNORES,e=>new RegExp(e).test(t))}isIncludeAndNotExclude(t){var e,i,{include:a,exclude:o}=this.options;return i=!a||(0,u.testRule)(a,t),e=!!o&&(0,u.testRule)(o,t),i&&!e}connect(){this.isConnected||(this.client=new m.S3(this.clientConfig.s3Options),this.isConnected=!0)}transformBasePath(){return Promise.resolve(this.basePathTransform(this.options.basePath)).then(u.addTrailingS3Sep).then(t=>this.options.basePath=t)}setupProgressBar(t){const e=t.reduce((t,{upload:e})=>e.totalBytes+t,0),i=new s.default("Uploading [:bar] :percent :etas",{complete:">",incomplete:"âˆ†",total:e});var a=0;t.forEach(function({upload:t}){t.on("httpUploadProgress",function({loaded:t}){a+=t,i.update(a)})})}prioritizeFiles(t){const e=[...t],i=this.options.priority.map(t=>l.default.remove(e,e=>t.test(e.name)));return[e,...i]}uploadPriorityChunk(t){const e=t.map(t=>this.uploadFile(t.name,t.path));return Promise.all(e.map(({promise:t})=>t))}uploadInPriorityOrder(t){return this.prioritizeFiles(t).map(t=>()=>this.uploadPriorityChunk(t)).reduce((t,e)=>t.then(e),Promise.resolve())}uploadFiles(t=[]){return this.transformBasePath().then(()=>{if(this.options.priority)return this.uploadInPriorityOrder(t);{const e=t.map(t=>this.uploadFile(t.name,t.path));return this.options.progress&&this.setupProgressBar(e),Promise.all(e.map(({promise:t})=>t))}})}uploadFile(t,e){let i=this.options.basePath+t;const a=l.default.mapValues(this.uploadOptions,i=>l.default.isFunction(i)?i(t,e):i);"/"===i[0]&&(i=i.substr(1)),void 0===a.ContentType&&(a.ContentType=c.default.getType(t));const o=n.default.createReadStream(e),p=this.client.upload(l.default.merge({Key:i,Body:o},u.DEFAULT_UPLOAD_OPTIONS,a));return this.noCdnizer||this.cdnizerOptions.files.push(`*${t}*`),{upload:p,promise:p.promise()}}invalidateCloudfront(){const{clientConfig:t,cloudfrontInvalidateOptions:e}=this;if(e.DistributionId){const{accessKeyId:i,secretAccessKey:a,sessionToken:o}=t.s3Options,n=new m.CloudFront({accessKeyId:i,secretAccessKey:a,sessionToken:o});l.default.isArray(e.DistributionId)||(e.DistributionId=[e.DistributionId]);const p=e.DistributionId.map(t=>new Promise((i,a)=>{n.createInvalidation({DistributionId:t,InvalidationBatch:{CallerReference:Date.now().toString(),Paths:{Quantity:e.Items.length,Items:e.Items}}},(t,e)=>{t?a(t):i(e.Id)})}));return Promise.all(p)}return Promise.resolve(null)}}},function(t,e){t.exports=require("http")},function(t,e){t.exports=require("https")},function(t,e){t.exports=require("fs")},function(t,i){t.exports=e},function(t,e){t.exports=i},function(t,e,i){"use strict";var a=i(9);t.exports=new a(i(10))},function(t,e,i){"use strict";function a(){this._types=Object.create(null),this._extensions=Object.create(null);for(var t=0;t<arguments.length;t++)this.define(arguments[t])}a.prototype.define=function(t,e){for(var i in t){for(var a=t[i],o=0;o<a.length;o++){if("*"!=(n=a[o])[0]){if(!e&&n in this._types)throw new Error('Attempt to change mapping for "'+n+'" extension from "'+this._types[n]+'" to "'+i+'". Pass `force=true` to allow this, otherwise remove "'+n+'" from the list of extensions for "'+i+'".');this._types[n]=i}}if(e||!this._extensions[i]){var n=a[0];this._extensions[i]="*"!=n[0]?n:n.substr(1)}}},a.prototype.getType=function(t){var e=(t=String(t)).replace(/^.*[/\\]/,"").toLowerCase(),i=e.replace(/^.*\./,"").toLowerCase(),a=e.length<t.length;return(i.length<e.length-1||!a)&&this._types[i]||null},a.prototype.getExtension=function(t){return(t=/^\s*([^;\s]*)/.test(t)&&RegExp.$1)&&this._extensions[t.toLowerCase()]||null},t.exports=a},function(t){t.exports={"application/andrew-inset":["ez"],"application/applixware":["aw"],"application/atom+xml":["atom"],"application/atomcat+xml":["atomcat"],"application/atomsvc+xml":["atomsvc"],"application/bdoc":["bdoc"],"application/ccxml+xml":["ccxml"],"application/cdmi-capability":["cdmia"],"application/cdmi-container":["cdmic"],"application/cdmi-domain":["cdmid"],"application/cdmi-object":["cdmio"],"application/cdmi-queue":["cdmiq"],"application/cu-seeme":["cu"],"application/dash+xml":["mpd"],"application/davmount+xml":["davmount"],"application/docbook+xml":["dbk"],"application/dssc+der":["dssc"],"application/dssc+xml":["xdssc"],"application/ecmascript":["ecma"],"application/emma+xml":["emma"],"application/epub+zip":["epub"],"application/exi":["exi"],"application/font-tdpfr":["pfr"],"application/font-woff":["woff"],"application/geo+json":["geojson"],"application/gml+xml":["gml"],"application/gpx+xml":["gpx"],"application/gxf":["gxf"],"application/gzip":["gz"],"application/hjson":["hjson"],"application/hyperstudio":["stk"],"application/inkml+xml":["ink","inkml"],"application/ipfix":["ipfix"],"application/java-archive":["jar","war","ear"],"application/java-serialized-object":["ser"],"application/java-vm":["class"],"application/javascript":["js","mjs"],"application/json":["json","map"],"application/json5":["json5"],"application/jsonml+json":["jsonml"],"application/ld+json":["jsonld"],"application/lost+xml":["lostxml"],"application/mac-binhex40":["hqx"],"application/mac-compactpro":["cpt"],"application/mads+xml":["mads"],"application/manifest+json":["webmanifest"],"application/marc":["mrc"],"application/marcxml+xml":["mrcx"],"application/mathematica":["ma","nb","mb"],"application/mathml+xml":["mathml"],"application/mbox":["mbox"],"application/mediaservercontrol+xml":["mscml"],"application/metalink+xml":["metalink"],"application/metalink4+xml":["meta4"],"application/mets+xml":["mets"],"application/mods+xml":["mods"],"application/mp21":["m21","mp21"],"application/mp4":["mp4s","m4p"],"application/msword":["doc","dot"],"application/mxf":["mxf"],"application/octet-stream":["bin","dms","lrf","mar","so","dist","distz","pkg","bpk","dump","elc","deploy","exe","dll","deb","dmg","iso","img","msi","msp","msm","buffer"],"application/oda":["oda"],"application/oebps-package+xml":["opf"],"application/ogg":["ogx"],"application/omdoc+xml":["omdoc"],"application/onenote":["onetoc","onetoc2","onetmp","onepkg"],"application/oxps":["oxps"],"application/patch-ops-error+xml":["xer"],"application/pdf":["pdf"],"application/pgp-encrypted":["pgp"],"application/pgp-signature":["asc","sig"],"application/pics-rules":["prf"],"application/pkcs10":["p10"],"application/pkcs7-mime":["p7m","p7c"],"application/pkcs7-signature":["p7s"],"application/pkcs8":["p8"],"application/pkix-attr-cert":["ac"],"application/pkix-cert":["cer"],"application/pkix-crl":["crl"],"application/pkix-pkipath":["pkipath"],"application/pkixcmp":["pki"],"application/pls+xml":["pls"],"application/postscript":["ai","eps","ps"],"application/pskc+xml":["pskcxml"],"application/raml+yaml":["raml"],"application/rdf+xml":["rdf"],"application/reginfo+xml":["rif"],"application/relax-ng-compact-syntax":["rnc"],"application/resource-lists+xml":["rl"],"application/resource-lists-diff+xml":["rld"],"application/rls-services+xml":["rs"],"application/rpki-ghostbusters":["gbr"],"application/rpki-manifest":["mft"],"application/rpki-roa":["roa"],"application/rsd+xml":["rsd"],"application/rss+xml":["rss"],"application/rtf":["rtf"],"application/sbml+xml":["sbml"],"application/scvp-cv-request":["scq"],"application/scvp-cv-response":["scs"],"application/scvp-vp-request":["spq"],"application/scvp-vp-response":["spp"],"application/sdp":["sdp"],"application/set-payment-initiation":["setpay"],"application/set-registration-initiation":["setreg"],"application/shf+xml":["shf"],"application/smil+xml":["smi","smil"],"application/sparql-query":["rq"],"application/sparql-results+xml":["srx"],"application/srgs":["gram"],"application/srgs+xml":["grxml"],"application/sru+xml":["sru"],"application/ssdl+xml":["ssdl"],"application/ssml+xml":["ssml"],"application/tei+xml":["tei","teicorpus"],"application/thraud+xml":["tfi"],"application/timestamped-data":["tsd"],"application/voicexml+xml":["vxml"],"application/wasm":["wasm"],"application/widget":["wgt"],"application/winhlp":["hlp"],"application/wsdl+xml":["wsdl"],"application/wspolicy+xml":["wspolicy"],"application/xaml+xml":["xaml"],"application/xcap-diff+xml":["xdf"],"application/xenc+xml":["xenc"],"application/xhtml+xml":["xhtml","xht"],"application/xml":["xml","xsl","xsd","rng"],"application/xml-dtd":["dtd"],"application/xop+xml":["xop"],"application/xproc+xml":["xpl"],"application/xslt+xml":["xslt"],"application/xspf+xml":["xspf"],"application/xv+xml":["mxml","xhvml","xvml","xvm"],"application/yang":["yang"],"application/yin+xml":["yin"],"application/zip":["zip"],"audio/3gpp":["*3gpp"],"audio/adpcm":["adp"],"audio/basic":["au","snd"],"audio/midi":["mid","midi","kar","rmi"],"audio/mp3":["*mp3"],"audio/mp4":["m4a","mp4a"],"audio/mpeg":["mpga","mp2","mp2a","mp3","m2a","m3a"],"audio/ogg":["oga","ogg","spx"],"audio/s3m":["s3m"],"audio/silk":["sil"],"audio/wav":["wav"],"audio/wave":["*wav"],"audio/webm":["weba"],"audio/xm":["xm"],"font/collection":["ttc"],"font/otf":["otf"],"font/ttf":["ttf"],"font/woff":["*woff"],"font/woff2":["woff2"],"image/apng":["apng"],"image/bmp":["bmp"],"image/cgm":["cgm"],"image/g3fax":["g3"],"image/gif":["gif"],"image/ief":["ief"],"image/jp2":["jp2","jpg2"],"image/jpeg":["jpeg","jpg","jpe"],"image/jpm":["jpm"],"image/jpx":["jpx","jpf"],"image/ktx":["ktx"],"image/png":["png"],"image/sgi":["sgi"],"image/svg+xml":["svg","svgz"],"image/tiff":["tiff","tif"],"image/webp":["webp"],"message/disposition-notification":["disposition-notification"],"message/global":["u8msg"],"message/global-delivery-status":["u8dsn"],"message/global-disposition-notification":["u8mdn"],"message/global-headers":["u8hdr"],"message/rfc822":["eml","mime"],"model/gltf+json":["gltf"],"model/gltf-binary":["glb"],"model/iges":["igs","iges"],"model/mesh":["msh","mesh","silo"],"model/vrml":["wrl","vrml"],"model/x3d+binary":["x3db","x3dbz"],"model/x3d+vrml":["x3dv","x3dvz"],"model/x3d+xml":["x3d","x3dz"],"text/cache-manifest":["appcache","manifest"],"text/calendar":["ics","ifb"],"text/coffeescript":["coffee","litcoffee"],"text/css":["css"],"text/csv":["csv"],"text/html":["html","htm","shtml"],"text/jade":["jade"],"text/jsx":["jsx"],"text/less":["less"],"text/markdown":["markdown","md"],"text/mathml":["mml"],"text/n3":["n3"],"text/plain":["txt","text","conf","def","list","log","in","ini"],"text/richtext":["rtx"],"text/rtf":["*rtf"],"text/sgml":["sgml","sgm"],"text/shex":["shex"],"text/slim":["slim","slm"],"text/stylus":["stylus","styl"],"text/tab-separated-values":["tsv"],"text/troff":["t","tr","roff","man","me","ms"],"text/turtle":["ttl"],"text/uri-list":["uri","uris","urls"],"text/vcard":["vcard"],"text/vtt":["vtt"],"text/xml":["*xml"],"text/yaml":["yaml","yml"],"video/3gpp":["3gp","3gpp"],"video/3gpp2":["3g2"],"video/h261":["h261"],"video/h263":["h263"],"video/h264":["h264"],"video/jpeg":["jpgv"],"video/jpm":["*jpm","jpgm"],"video/mj2":["mj2","mjp2"],"video/mp2t":["ts"],"video/mp4":["mp4","mp4v","mpg4"],"video/mpeg":["mpeg","mpg","mpe","m1v","m2v"],"video/ogg":["ogv"],"video/quicktime":["qt","mov"],"video/webm":["webm"]}},function(t,e){t.exports=a},function(t){t.exports={name:"webpack-s3-plugin",version:"1.0.2",description:"Uploads compiled assets to s3 after build",main:"dist/s3_plugin.js",scripts:{build:"webpack --mode production",prepublishOnly:"npm run lint && npm run test && npm run build",test:"NODE_ENV='test' mocha -t 10000 --require babel-register",lint:"eslint ./src ./test",watch:"webpack --watch --mode development","prep:major":"npm run build && npm version major","prep:minor":"npm run build && npm version minor","prep:patch":"npm run build && npm version patch"},repository:{type:"git",url:"git@github.com:webpack-contrib/s3-plugin-webpack.git"},keywords:["s3","webpack","node","upload","production"],author:"Mika Kalathil",license:"MIT",bugs:{url:"https://github.com/webpack-contrib/s3-plugin-webpack/issues"},homepage:"https://github.com/webpack-contrib/s3-plugin-webpack",dependencies:{"aws-sdk":"^2.282.1",cdnizer:"^3.0.1",lodash:"^4.17.11",mime:"^2.3.1",progress:"^2.0.0","recursive-readdir":"^2.2.2"},devDependencies:{"babel-core":"^6.26.0","babel-loader":"^7.1.4","babel-preset-env":"^1.6.1",chai:"^4.1.2","css-loader":"^0.28.11",dotenv:"^5.0.1",eslint:"^4.19.1","eslint-loader":"^2.0.0","extract-text-webpack-plugin":"^4.0.0-beta.0","file-loader":"^1.1.11","html-webpack-plugin":"^3.2.0",mocha:"^5.0.5",sinon:"^4.5.0","style-loader":"^0.20.3",webpack:"^4.16.5","webpack-cli":"^3.1.0"},peerDependencies:{webpack:">=4.0.0"}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.testRule=e.getDirectoryFilesRecursive=e.translatePathFromFiles=e.addSeperatorToPath=e.addTrailingS3Sep=e.DEFAULT_TRANSFORM=e.S3_PATH_SEP=e.PATH_SEP=e.REQUIRED_S3_UP_OPTS=e.DEFAULT_UPLOAD_OPTIONS=e.UPLOAD_IGNORES=void 0;var a=p(i(1)),o=p(i(0)),n=p(i(14));function p(t){return t&&t.__esModule?t:{default:t}}e.UPLOAD_IGNORES=[".DS_Store"],e.DEFAULT_UPLOAD_OPTIONS={ACL:"public-read"},e.REQUIRED_S3_UP_OPTS=["Bucket"];const s=e.PATH_SEP=o.default.sep,r=e.S3_PATH_SEP="/",l=(e.DEFAULT_TRANSFORM=(t=>Promise.resolve(t)),e.addTrailingS3Sep=(t=>t?t.replace(/\/?(\?|#|$)/,"/$1"):t),e.addSeperatorToPath=(t=>t?a.default.endsWith(t,s)?t:t+s:t),e.translatePathFromFiles=(t=>e=>a.default.map(e,e=>({path:e,name:e.replace(t,"").split(s).join(r)})))),c=(e.getDirectoryFilesRecursive=((t,e=[])=>new Promise((i,a)=>{(0,n.default)(t,e,(t,e)=>t?a(t):i(e))}).then(l(t))),e.testRule=((t,e)=>{if(a.default.isRegExp(t))return t.test(e);if(a.default.isFunction(t))return!!t(e);if(a.default.isArray(t))return a.default.every(t,t=>c(t,e));if(a.default.isString(t))return new RegExp(t).test(e);throw new Error("Invalid include / exclude rule")}))},function(t,e){t.exports=o}])});